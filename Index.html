 <!DOCTYPE html> <html lang="en"> <head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>GPS Shift Tracker with Reporting</title>    <!-- Load Tailwind CSS for styling -->    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>    <style>        /* Custom styles for aesthetic buttons and main container */        body {            font-family: 'Inter', sans-serif;            background-color: #f7f9fb;        }        .container {            max-width: 420px; /* Mobile width constraint */        }        .shadow-main {            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);        }        .report-table th, .report-table td {            padding: 8px 12px;            text-align: left;            border-bottom: 1px solid #e5e7eb;        }        .report-table th {            background-color: #f3f4f6;            font-weight: 600;            color: #4b5563;            text-transform: uppercase;            font-size: 0.75rem;        }        /* Define the pulse animation for urgency */        .animate-pulse {            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;        }        @keyframes pulse {            0%, 100% {                opacity: 1;            }            50% {                opacity: .5;            }        }    </style> </head> <body class="min-h-screen p-4 flex flex-col items-center">    <div class="container w-full bg-white p-6 rounded-xl shadow-main mt-8">         <!-- Toggle Buttons -->        <div class="flex justify-center mb-6 space-x-2">            <button id="showTrackerBtn" class="py-2 px-4 rounded-full text-sm font-semibold transition duration-200 bg-indigo-600 text-white hover:bg-indigo-700">                Shift Tracker            </button>            <button id="showReportBtn" class="py-2 px-4 rounded-full text-sm font-semibold transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">                Shift Report            </button>        </div>         <!-- Shift Tracker View -->        <div id="trackerView">            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">Shift Tracker</h1>            <p class="text-center text-sm text-gray-500 mb-6">Location-verified clock-in/out.</p>             <!-- Geofence Information -->            <div id="geofenceInfo" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">                <p class="font-semibold text-blue-700">Work Location (Geofence):</p>                <p class="text-xs text-blue-600">Lat: <span id="workLat"></span>, Lng: <span id="workLng"></span></p>                <p class="text-xs text-blue-600">Radius: <span id="workRadius"></span> meters</p>                <p class="text-xs text-blue-600 font-bold mt-2">Status: Location set near London, UK. (Radius 100m)</p>            </div>             <!-- Proximity Reminder Box -->            <div id="proximityReminder" class="p-3 rounded-lg text-center hidden mb-6">                <!-- Content inserted by JS -->            </div>             <!-- Status & User Info -->            <div id="userInfo" class="bg-gray-100 p-4 rounded-lg mb-6">                <p class="font-semibold text-gray-700">Status: <span id="statusDisplay" class="font-bold text-red-500">Loading...</span></p>                <p class="text-xs text-gray-500 mt-1">User ID: <span id="userIdDisplay" class="font-mono text-xs break-all">...</span></p>                <p class="text-xs text-gray-500 mt-1">Current Shift ID: <span id="currentShiftId" class="font-mono text-xs break-all text-indigo-600">None</span></p>            </div>             <!-- Action Buttons -->            <div class="flex space-x-4 mb-8">                <button id="clockInBtn"                        class="flex-1 py-3 px-4 rounded-lg font-bold text-white transition duration-300 bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50"                        disabled>                    Clock In                </button>                <button id="clockOutBtn"                        class="flex-1 py-3 px-4 rounded-lg font-bold text-white transition duration-300 bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 disabled:opacity-50"                        disabled>                    Clock Out                </button>            </div>             <!-- Message/Loading Box -->            <div id="messageBox" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>             <!-- Shift History -->            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">Recent Shifts</h2>            <div id="shiftHistory" class="space-y-4">                <p class="text-center text-gray-500" id="loadingHistory">Loading history...</p>            </div>        </div>         <!-- Shift Report View (Hidden by default) -->        <div id="reportView" class="hidden">            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Shift Report</h1>             <!-- Summary Card -->            <div class="bg-indigo-100 p-4 rounded-xl mb-6 shadow-md">                <p class="text-sm font-semibold text-indigo-700">Total Completed Shifts:</p>                <p id="totalShifts" class="text-3xl font-bold text-indigo-900">0</p>                <p class="text-sm font-semibold text-indigo-700 mt-3">Total Hours Tracked:</p>                <p id="totalHours" class="text-3xl font-bold text-indigo-900">0.00</p>            </div>             <!-- Data Table -->            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">Completed Shifts Detail</h2>            <div class="overflow-x-auto rounded-lg shadow-md border">                <table class="w-full report-table" id="reportTable">                    <thead>                        <tr>                            <th>Date</th>                            <th>Start Time</th>                            <th>End Time</th>                            <th>Duration (hrs)</th>                            <th>In Dist (m)</th>                        </tr>                    </thead>                    <tbody>                        <!-- Report data will be inserted here -->                        <tr><td colspan="5" class="text-center text-gray-500 py-4">No completed shifts to report.</td></tr>                    </tbody>                </table>            </div>        </div>     </div>     <script type="module">        // Import necessary Firebase modules        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, where } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";        import { setLogLevel } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";         // --- Geofence Configuration ---        const PROXIMITY_CHECK_INTERVAL = 30000; // Check location every 30 seconds         const WORK_LOCATION = {            // Location: London, UK (51.4857806, -0.1995771)            lat: 51.4857806,            lng: -0.1995771,            radiusMeters: 100 // Allowed distance from center point to clock in/out        };         // --- Global Firebase & App Variables ---        let app;        let db;        let auth;        let userId = null;        let currentShiftIdValue = null;        let proximityInterval = null; // Stores the interval timer ID        let isNearWork = false; // Tracks if the user is currently near the work location         // HTML Elements        const trackerView = document.getElementById('trackerView');        const reportView = document.getElementById('reportView');        const showTrackerBtn = document.getElementById('showTrackerBtn');        const showReportBtn = document.getElementById('showReportBtn');         const statusDisplay = document.getElementById('statusDisplay');        const userIdDisplay = document.getElementById('userIdDisplay');        const currentShiftId = document.getElementById('currentShiftId');        const clockInBtn = document.getElementById('clockInBtn');        const clockOutBtn = document.getElementById('clockOutBtn');        const shiftHistory = document.getElementById('shiftHistory');        const messageBox = document.getElementById('messageBox');        const workLat = document.getElementById('workLat');        const workLng = document.getElementById('workLng');        const workRadius = document.getElementById('workRadius');        const proximityReminder = document.getElementById('proximityReminder');         const totalShiftsDisplay = document.getElementById('totalShifts');        const totalHoursDisplay = document.getElementById('totalHours');        const reportTableBody = document.querySelector('#reportTable tbody');         // Firestore Config        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;        const SHIFTS_COLLECTION_PATH = `/artifacts/${appId}/users/`;         // Initialize Geofence UI Display        workLat.textContent = WORK_LOCATION.lat.toFixed(6);        workLng.textContent = WORK_LOCATION.lng.toFixed(6);        workRadius.textContent = WORK_LOCATION.radiusMeters;         // Function to display a temporary message in the message box        function showMessage(msg, type = 'yellow', calendarLink = null) {            messageBox.innerHTML = '';            messageBox.className = `p-3 bg-${type}-100 text-${type}-800 rounded-lg`;            messageBox.style.display = 'block';             const textNode = document.createElement('p');            textNode.textContent = msg;            messageBox.appendChild(textNode);             if (calendarLink) {                const linkButton = document.createElement('button');                linkButton.textContent = 'Add to Google Calendar';                linkButton.className = 'mt-3 w-full py-2 px-4 rounded-lg font-bold text-white transition duration-300 bg-indigo-600 hover:bg-indigo-700';                linkButton.onclick = () => window.open(calendarLink, '_blank');                messageBox.appendChild(linkButton);            }             // Only auto-hide if no calendar link is present            if (!calendarLink) {                setTimeout(() => {                    messageBox.style.display = 'none';                }, 5000);            }        }         // --- Calendar Integration Function ---         function formatToGoogleCalendarTime(isoString) {            // Converts ISO string (e.g., "2023-10-27T15:30:00.000Z") to basic format (20231027T153000Z)            // Google Calendar requires a compressed UTC format (Z suffix)            return isoString.replace(/[-:]/g, '').split('.')[0] + 'Z';        }         function createCalendarEventLink(startTimeISO, endTimeISO, durationHours) {            const startFormat = formatToGoogleCalendarTime(startTimeISO);            const endFormat = formatToGoogleCalendarTime(endTimeISO);             const startDate = new Date(startTimeISO).toLocaleDateString('en-US');             const title = encodeURIComponent(`[Shift] ${startDate} (${durationHours} hrs)`);            const details = encodeURIComponent(`Shift recorded via GPS Shift Tracker App.\nStart: ${new Date(startTimeISO).toLocaleString()}\nEnd: ${new Date(endTimeISO).toLocaleString()}`);            const location = encodeURIComponent(`Work Site (Geofence: ${WORK_LOCATION.lat.toFixed(6)}, ${WORK_LOCATION.lng.toFixed(6)})`);             // Google Calendar URL structure            return `https://calendar.google.com/calendar/r/eventedit?text=${title}&dates=${startFormat}/${endFormat}&details=${details}&location=${location}&sf=true&output=xml`;        }          // --- Geolocation and Distance Calculation ---         // Haversine distance calculation (simple approximation)        function getDistance(lat1, lon1, lat2, lon2) {            const R = 6371e3;            const φ1 = lat1 * Math.PI/180;            const φ2 = lat2 * Math.PI/180;            const Δφ = (lat2-lat1) * Math.PI/180;            const Δλ = (lon2-lon1) * Math.PI/180;             const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +                      Math.cos(φ1) * Math.cos(φ2) *                      Math.sin(Δλ/2) * Math.sin(Δλ/2);            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));             const d = R * c; // in meters            return d;        }         function getCurrentLocation() {            return new Promise((resolve, reject) => {                if (navigator.geolocation) {                    // Use showMessage only for intentional clock in/out                    if (!proximityInterval) {                        showMessage("Acquiring GPS location...", 'blue');                    }                     navigator.geolocation.getCurrentPosition(                        (position) => {                            if (!proximityInterval) showMessage("GPS acquired successfully.", 'green');                            resolve({                                lat: position.coords.latitude,                                lng: position.coords.longitude,                                accuracy: position.coords.accuracy,                                timestamp: new Date().toISOString()                            });                        },                        (error) => {                            let msg = "Geolocation failed: ";                            if (error.code === error.PERMISSION_DENIED) {                                msg += "User denied the request for Geolocation. Please enable location services for this browser.";                            } else if (error.code === error.POSITION_UNAVAILABLE) {                                msg += "Location information is unavailable.";                            } else if (error.code === error.TIMEOUT) {                                msg += "The request to get user location timed out.";                            } else {                                msg += "An unknown error occurred.";                            }                            // Only show error message for manual action, suppress for background checks                            if (!proximityInterval) showMessage(msg, 'red');                            reject(new Error(msg));                        },                        {                            enableHighAccuracy: true,                            timeout: 10000,                            maximumAge: 0                        }                    );                } else {                    const msg = "Geolocation is not supported by this browser.";                    showMessage(msg, 'red');                    reject(new Error(msg));                }            });        }         // --- Proximity Check Functions ---         async function checkProximity() {            // Only run if authenticated and currently OFF the clock            if (!userId || currentShiftIdValue) {                return stopProximityCheck();            }             try {                // Use a lighter location request for continuous polling                const location = await new Promise((resolve, reject) => {                    navigator.geolocation.getCurrentPosition(                        (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),                        () => reject(new Error("Low-priority geolocation failed")),                        // Lower accuracy is acceptable for reminder, faster timeout                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }                    );                });                 const distance = getDistance(location.lat, location.lng, WORK_LOCATION.lat, WORK_LOCATION.lng);                 if (distance <= WORK_LOCATION.radiusMeters) {                    // User is inside the geofence                    isNearWork = true;                    proximityReminder.classList.remove('hidden');                    proximityReminder.classList.add('bg-yellow-100', 'text-yellow-800');                    proximityReminder.textContent = `REMINDER: You are ${distance.toFixed(0)}m from work. Click CLOCK IN now!`;                    clockInBtn.classList.add('animate-pulse'); // Add visual urgency                } else {                    // User is outside the geofence                    isNearWork = false;                    proximityReminder.classList.add('hidden');                    proximityReminder.classList.remove('bg-yellow-100', 'text-yellow-800');                    clockInBtn.classList.remove('animate-pulse');                }             } catch (error) {                // Suppress constant error messages for background checks                if (isNearWork) {                    isNearWork = false;                    proximityReminder.classList.add('hidden');                    clockInBtn.classList.remove('animate-pulse');                }            }        }         function startProximityCheck() {            if (proximityInterval) clearInterval(proximityInterval);             // Check immediately, then every 30 seconds            checkProximity();            proximityInterval = setInterval(checkProximity, PROXIMITY_CHECK_INTERVAL);        }         function stopProximityCheck() {            if (proximityInterval) {                clearInterval(proximityInterval);                proximityInterval = null;            }            // Clear the visual reminder            proximityReminder.classList.add('hidden');            proximityReminder.classList.remove('bg-yellow-100', 'text-yellow-800');            clockInBtn.classList.remove('animate-pulse');        }         // --- Database Functions ---         async function clockIn() {            if (!userId) return showMessage("Authentication not ready.", 'red');             try {                // 1. Get location (uses high accuracy, triggers message box)                const location = await getCurrentLocation();                 // 2. Perform Geofence Check                const distance = getDistance(                    location.lat, location.lng,                    WORK_LOCATION.lat, WORK_LOCATION.lng                );                 if (distance > WORK_LOCATION.radiusMeters) {                    return showMessage(                        `Clock-in denied. You are ${distance.toFixed(2)}m away from the work location. Max allowed is ${WORK_LOCATION.radiusMeters}m.`,                        'red'                    );                }                 // 3. Create new shift document                const shiftData = {                    userId: userId,                    startTime: location.timestamp,                    startLocation: location,                    startDistance: distance.toFixed(2),                    endTime: null,                    endLocation: null,                    endDistance: null,           %2…