<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Shift Tracker (Final Local)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic buttons and main container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 420px; /* Mobile width constraint */
        }
        .shadow-main {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .report-table th, .report-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        /* Define the pulse animation for urgency */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">
    <div class="container w-full bg-white p-6 rounded-xl shadow-main mt-8">
        
        <!-- Toggle Buttons -->
        <div class="flex justify-center mb-6 space-x-2">
            <button id="showTrackerBtn" class="py-2 px-4 rounded-full text-sm font-semibold transition duration-200 bg-indigo-600 text-white hover:bg-indigo-700">
                Shift Tracker
            </button>
            <button id="showReportBtn" class="py-2 px-4 rounded-full text-sm font-semibold transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">
                Shift Report
            </button>
        </div>

        <!-- Shift Tracker View -->
        <div id="trackerView">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">Shift Tracker</h1>
            <p class="text-center text-sm text-gray-500 mb-6">Local Storage Edition</p>

            <!-- Geofence Information -->
            <div id="geofenceInfo" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">
                <p class="font-semibold text-blue-700">Work Location (Geofence):</p>
                <p class="text-xs text-blue-600">Lat: <span id="workLat"></span>, Lng: <span id="workLng"></span></p>
                <p class="text-xs text-blue-600">Radius: <span id="workRadius"></span> meters</p>
                <p class="text-xs text-blue-600 font-bold mt-2">Status: Location set near London, UK. (Radius 100m)</p>
            </div>

            <!-- Proximity Reminder Box -->
            <div id="proximityReminder" class="p-3 rounded-lg text-center hidden mb-6">
                <!-- Content inserted by JS -->
            </div>

            <!-- Status & User Info -->
            <div id="userInfo" class="bg-gray-100 p-4 rounded-lg mb-6">
                <p class="font-semibold text-gray-700">Status: <span id="statusDisplay" class="font-bold text-green-600">Off Clock</span></p>
                <p class="text-xs text-gray-500 mt-1">Storage Key: <span id="storageKeyDisplay" class="font-mono text-xs break-all">Local Shifts</span></p>
                <p class="text-xs text-gray-500 mt-1">Current Shift: <span id="currentShiftId" class="font-mono text-xs break-all text-indigo-600">None</span></p>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4 mb-8">
                <button id="clockInBtn" 
                        class="flex-1 py-3 px-4 rounded-lg font-bold text-white transition duration-300 bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300">
                    Clock In
                </button>
                <button id="clockOutBtn" 
                        class="flex-1 py-3 px-4 rounded-lg font-bold text-white transition duration-300 bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300"
                        disabled>
                    Clock Out
                </button>
            </div>

            <!-- Message/Loading Box -->
            <div id="messageBox" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>

            <!-- Shift History -->
            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">Recent Shifts (Local)</h2>
            <div id="shiftHistory" class="space-y-4">
                <p class="text-center text-gray-500" id="loadingHistory">Loading history...</p>
            </div>
        </div>

        <!-- Shift Report View (Hidden by default) -->
        <div id="reportView" class="hidden">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Shift Report</h1>

            <!-- Summary Card -->
            <div class="bg-indigo-100 p-4 rounded-xl mb-6 shadow-md">
                <p class="text-sm font-semibold text-indigo-700">Total Completed Shifts:</p>
                <p id="totalShifts" class="text-3xl font-bold text-indigo-900">0</p>
                <p class="text-sm font-semibold text-indigo-700 mt-3">Total Hours Tracked:</p>
                <p id="totalHours" class="text-3xl font-bold text-indigo-900">0.00</p>
            </div>

            <!-- Data Table -->
            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">Completed Shifts Detail</h2>
            <div class="overflow-x-auto rounded-lg shadow-md border">
                <table class="w-full report-table" id="reportTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration (hrs)</th>
                            <th>In Dist (m)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Report data will be inserted here -->
                        <tr><td colspan="5" class="text-center text-gray-500 py-4">No completed shifts to report.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    
    <script type="text/javascript">
        // --- Geofence Configuration ---
        const PROXIMITY_CHECK_INTERVAL = 30000; // Check location every 30 seconds
        const LOCAL_STORAGE_KEY = 'shiftTrackerData';
        
        const WORK_LOCATION = {
            // Location: London, UK (51.4857806, -0.1995771)
            lat: 51.4857806, 
            lng: -0.1995771, 
            radiusMeters: 100 // Allowed distance from center point to clock in/out
        };
        
        // --- Global State Variables ---
        let currentShiftIdValue = null;
        let proximityInterval = null; 

        // HTML Elements
        const trackerView = document.getElementById('trackerView');
        const reportView = document.getElementById('reportView');
        const showTrackerBtn = document.getElementById('showTrackerBtn');
        const showReportBtn = document.getElementById('showReportBtn');
        const statusDisplay = document.getElementById('statusDisplay');
        const currentShiftId = document.getElementById('currentShiftId');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');
        const shiftHistory = document.getElementById('shiftHistory');
        const messageBox = document.getElementById('messageBox');
        const workLat = document.getElementById('workLat');
        const workLng = document.getElementById('workLng');
        const workRadius = document.getElementById('workRadius');
        const proximityReminder = document.getElementById('proximityReminder');
        const totalShiftsDisplay = document.getElementById('totalShifts');
        const totalHoursDisplay = document.getElementById('totalHours');
        const reportTableBody = document.querySelector('#reportTable tbody');

        // Initialize Geofence UI Display
        workLat.textContent = WORK_LOCATION.lat.toFixed(6);
        workLng.textContent = WORK_LOCATION.lng.toFixed(6);
        workRadius.textContent = WORK_LOCATION.radiusMeters;

        // Function to display a temporary message in the message box
        function showMessage(msg, type = 'yellow', calendarLink = null) {
            messageBox.innerHTML = '';
            messageBox.className = `p-3 bg-${type}-100 text-${type}-800 rounded-lg`;
            messageBox.style.display = 'block';

            const textNode = document.createElement('p');
            textNode.textContent = msg;
            messageBox.appendChild(textNode);

            if (calendarLink) {
                const linkButton = document.createElement('button');
                linkButton.textContent = 'Add to Google Calendar';
                linkButton.className = 'mt-3 w-full py-2 px-4 rounded-lg font-bold text-white transition duration-300 bg-indigo-600 hover:bg-indigo-700';
                linkButton.onclick = () => window.open(calendarLink, '_blank');
                messageBox.appendChild(linkButton);
            }

            if (!calendarLink) {
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 5000);
            }
        }

        // --- Local Storage Functions (CRITICAL for this version) ---

        function getShifts() {
            // Load shift data from the browser's local memory
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveShifts(shifts) {
            // Save shift data to the browser's local memory
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(shifts));
            updateUI(shifts); // Update the interface immediately after saving
        }

        function getActiveShift(shifts) {
            return shifts.find(s => s.status === 'active');
        }

        function generateShiftId() {
            // Since there is no database, we use the timestamp as a unique ID
            return Date.now().toString(); 
        }
        
        // --- Geolocation and Distance Calculation ---

        // Haversine distance calculation
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const d = R * c; // in meters
            return d;
        }

        function getCurrentLocation() {
            // This relies on the browser's native GPS API, which is now allowed on HTTPS
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    if (!proximityInterval) {
                        showMessage("Acquiring GPS location...", 'blue');
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            if (!proximityInterval) showMessage("GPS acquired successfully.", 'green');
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: new Date().toISOString()
                            });
                        },
                        (error) => {
                            let msg = "Geolocation failed: ";
                            if (error.code === error.PERMISSION_DENIED) {
                                msg += "Permission Denied. Enable location services for this browser.";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                msg += "Location information is unavailable.";
                            } else if (error.code === error.TIMEOUT) {
                                msg += "Location request timed out. Try again outside.";
                            } else {
                                msg += "An unknown error occurred.";
                            }
                            if (!proximityInterval) showMessage(msg, 'red');
                            reject(new Error(msg));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    const msg = "Geolocation is not supported by this browser.";
                    showMessage(msg, 'red');
                    reject(new Error(msg));
                }
            });
        }
        
        // --- Proximity Check Functions ---

        async function checkProximity() {
            const shifts = getShifts();
            if (getActiveShift(shifts)) {
                return stopProximityCheck();
            }

            try {
                const location = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                        () => reject(new Error("Low-priority geolocation failed")),
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 } 
                    );
                });

                const distance = getDistance(location.lat, location.lng, WORK_LOCATION.lat, WORK_LOCATION.lng);
                
                if (distance <= WORK_LOCATION.radiusMeters) {
                    proximityReminder.classList.remove('hidden');
                    proximityReminder.classList.add('bg-yellow-100', 'text-yellow-800');
                    proximityReminder.textContent = `REMINDER: You are ${distance.toFixed(0)}m from work. Click CLOCK IN now!`;
                    clockInBtn.classList.add('animate-pulse');
                } else {
                    proximityReminder.classList.add('hidden');
                    proximityReminder.classList.remove('bg-yellow-100', 'text-yellow-800');
                    clockInBtn.classList.remove('animate-pulse');
                }

            } catch (error) {
                // Suppress constant error messages for background checks
                proximityReminder.classList.add('hidden');
                clockInBtn.classList.remove('animate-pulse');
            }
        }

        function startProximityCheck() {
            if (proximityInterval) clearInterval(proximityInterval);
            checkProximity();
            proximityInterval = setInterval(checkProximity, PROXIMITY_CHECK_INTERVAL);
        }

        function stopProximityCheck() {
            if (proximityInterval) {
                clearInterval(proximityInterval);
                proximityInterval = null;
            }
            proximityReminder.classList.add('hidden');
            clockInBtn.classList.remove('animate-pulse');
        }

        // --- Clock In/Out Logic ---
        
        async function clockIn() {
            const shifts = getShifts();
            if (getActiveShift(shifts)) return showMessage("Already clocked in.", 'red');

            try {
                // 1. Get location (This is where the GPS prompt will appear)
                const location = await getCurrentLocation();
                
                // 2. Perform Geofence Check
                const distance = getDistance(
                    location.lat, location.lng, 
                    WORK_LOCATION.lat, WORK_LOCATION.lng
                );
                
                if (distance > WORK_LOCATION.radiusMeters) {
                    return showMessage(
                        `Clock-in denied. You are ${distance.toFixed(2)}m away from work. Max allowed is ${WORK_LOCATION.radiusMeters}m.`, 
                        'red'
                    );
                }

                // 3. Create new shift
                const newShift = {
                    id: generateShiftId(),
                    startTime: location.timestamp,
                    startLocation: location,
                    startDistance: distance.toFixed(2), 
                    endTime: null,
                    endLocation: null,
                    duration: null,
                    status: 'active',
                };
                shifts.push(newShift);
                saveShifts(shifts);

                showMessage(`Clocked in successfully! Distance to site: ${distance.toFixed(2)}m.`, 'green');
                stopProximityCheck();

            } catch (error) {
                console.error("Error during clock in:", error);
                if (error.message.includes("Geolocation failed")) return;
                showMessage("Failed to clock in. See console for details.", 'red');
            }
        }

        async function clockOut() {
            let shifts = getShifts();
            const activeShiftIndex = shifts.findIndex(s => s.status === 'active');
            if (activeShiftIndex === -1) return showMessage("No active shift to clock out from.", 'red');
            
            try {
                const location = await getCurrentLocation();
                const shiftToUpdate = shifts[activeShiftIndex];

                // 1. Calculate duration
                const now = new Date();
                const startTime = new Date(shiftToUpdate.startTime);
                const durationMs = now.getTime() - startTime.getTime();
                const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(2);
                
                // 2. Geofence Check (Log distance)
                const distance = getDistance(
                    location.lat, location.lng, 
                    WORK_LOCATION.lat, WORK_LOCATION.lng
                );
                
                // 3. Update shift object
                shiftToUpdate.endTime = location.timestamp;
                shiftToUpdate.endLocation = location;
                shiftToUpdate.endDistance = distance.toFixed(2); 
                shiftToUpdate.duration = parseFloat(durationHours);
                shiftToUpdate.status = 'completed';
                
                shifts[activeShiftIndex] = shiftToUpdate;
                saveShifts(shifts);

                // 4. Generate Calendar Link
                const calendarLink = createCalendarEventLink(shiftToUpdate.startTime, shiftToUpdate.endTime, durationHours);
                
                showMessage(
                    `Clocked out. Duration: ${durationHours} hrs. Data saved locally.`, 
                    'green', 
                    calendarLink
                );
                startProximityCheck();

            } catch (error) {
                console.error("Error during clock out:", error);
                if (error.message.includes("Geolocation failed")) return;
                showMessage("Failed to clock out. See console.", 'red');
            }
        }

        // --- Calendar Function ---

        function createCalendarEventLink(startTimeISO, endTimeISO, durationHours) {
            const startFormat = startTimeISO.replace(/[-:]/g, '').split('.')[0] + 'Z';
            const endFormat = endTimeISO.replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const startDate = new Date(startTimeISO).toLocaleDateString('en-US');

            const title = encodeURIComponent(`[Shift] ${startDate} (${durationHours} hrs)`);
            const details = encodeURIComponent(`Shift recorded via Local Tracker App.\nStart: ${new Date(startTimeISO).toLocaleString()}\nEnd: ${new Date(endTimeISO).toLocaleString()}`);
            const location = encodeURIComponent(`Work Site (Geofence: ${WORK_LOCATION.lat.toFixed(6)}, ${WORK_LOCATION.lng.toFixed(6)})`);

            return `https://calendar.google.com/calendar/r/eventedit?text=${title}&dates=${startFormat}/${endFormat}&details=${details}&location=${location}&sf=true&output=xml`;
        }

        // --- UI & State Management ---

        function updateUI(shifts) {
            shifts.sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());
            
            const activeShift = getActiveShift(shifts);

            // Update Status Bar
            if (activeShift) {
                currentShiftIdValue = activeShift.id;
                statusDisplay.textContent = "On Clock";
                statusDisplay.className = "font-bold text-red-600";
                currentShiftId.textContent = activeShift.id;
                clockInBtn.disabled = true;
                clockOutBtn.disabled = false;
            } else {
                currentShiftIdValue = null;
                statusDisplay.textContent = "Off Clock";
                statusDisplay.className = "font-bold text-green-600";
                currentShiftId.textContent = "None";
                clockInBtn.disabled = false;
                clockOutBtn.disabled = true;
            }
            
            renderShiftHistory(shifts); 
            renderShiftReport(shifts);
        }

        function renderShiftHistory(shifts) {
            const loadingHistory = document.getElementById('loadingHistory');
            if (loadingHistory) loadingHistory.remove();
            shiftHistory.innerHTML = '';
            
            const recentShifts = shifts.slice(0, 5);
            if (recentShifts.length === 0) {
                shiftHistory.innerHTML = '<p class="text-center text-gray-500 py-4">No shift history recorded yet.</p>';
                return;
            }

            recentShifts.forEach(shift => {
                const isCompleted = shift.status === 'completed';
                const start = new Date(shift.startTime).toLocaleString();
                
                let end = '... In Progress ...';
                let duration = 'N/A';
                let durationClass = 'text-gray-500';
                let endDistance = 'N/A';

                if (isCompleted) {
                    end = new Date(shift.endTime).toLocaleString();
                    duration = `${shift.duration} hours`;
                    durationClass = 'text-green-600 font-semibold';
                    endDistance = `${shift.endDistance} m`;
                }

                const shiftElement = document.createElement('div');
                shiftElement.className = `p-3 rounded-lg border border-gray-200 ${isCompleted ? 'bg-white' : 'bg-indigo-50 border-indigo-300'}`;
                
                shiftElement.innerHTML = `
                    <p class="font-semibold text-sm mb-1 text-gray-800">Shift ID: <span class="text-xs text-gray-500">${shift.id}</span></p>
                    <p class="text-xs text-gray-600"><strong>Start:</strong> ${start} <span class="font-mono text-gray-400">(${shift.startDistance} m)</span></p>
                    <p class="text-xs text-gray-600"><strong>End:</strong> ${end} <span class="font-mono text-gray-400">(${endDistance})</span></p>
                    <p class="text-sm mt-1">Total Time: <span class="${durationClass}">${duration}</span></p>
                `;
                shiftHistory.appendChild(shiftElement);
            });
        }

        function renderShiftReport(shifts) {
            reportTableBody.innerHTML = '';
            let totalHours = 0;
            let completedShiftCount = 0;
            
            const completedShifts = shifts.filter(s => s.status === 'completed');
            
            if (completedShifts.length === 0) {
                reportTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No completed shifts to report.</td></tr>';
                totalShiftsDisplay.textContent = '0';
                totalHoursDisplay.textContent = '0.00';
                return;
            }

            completedShifts.forEach(shift => {
                if (shift.duration) {
                    totalHours += shift.duration;
                    completedShiftCount++;
                }
                
                const startDate = new Date(shift.startTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const startTime = new Date(shift.startTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const endTime = new Date(shift.endTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-sm">${startDate}</td>
                    <td class="text-sm">${startTime}</td>
                    <td class="text-sm">${endTime}</td>
                    <td class="text-sm font-semibold text-indigo-700">${shift.duration.toFixed(2)}</td>
                    <td class="text-xs text-gray-500">${shift.startDistance}</td>
                `;
                reportTableBody.appendChild(row);
            });

            totalShiftsDisplay.textContent = completedShiftCount;
            totalHoursDisplay.textContent = totalHours.toFixed(2);
        }

        // --- View Toggling ---
        function toggleView(view) {
            if (view === 'report') {
                trackerView.classList.add('hidden');
                reportView.classList.remove('hidden');
                showTrackerBtn.classList.remove('bg-indigo-600', 'text-white');
                showTrackerBtn.classList.add('bg-gray-200', 'text-gray-700');
                showReportBtn.classList.add('bg-indigo-600', 'text-white');
                showReportBtn.classList.remove('bg-gray-200', 'text-gray-700');
            } else { // 'tracker'
                trackerView.classList.remove('hidden');
                reportView.classList.add('hidden');
                showTrackerBtn.classList.add('bg-indigo-600', 'text-white');
                showTrackerBtn.classList.remove('bg-gray-200', 'text-gray-700');
                showReportBtn.classList.remove('bg-indigo-600', 'text-white');
                showReportBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
        }

        // --- Initialization ---

        function initApp() {
            // Load and update UI immediately using local storage data
            const shifts = getShifts();
            updateUI(shifts);
            startProximityCheck();

            // Set up event listeners for buttons
            clockInBtn.addEventListener('click', clockIn);
            clockOutBtn.addEventListener('click', clockOut);
            showTrackerBtn.addEventListener('click', () => toggleView('tracker'));
            showReportBtn.addEventListener('click', () => toggleView('report'));
            
            toggleView('tracker'); 
        }

        window.onload = initApp;
    </script>
</body>
</html>

